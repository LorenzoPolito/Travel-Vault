---
interface Props {
  lat?: number;
  lon?: number;
  zoom?: number;
  markers?: Array<{ lat: number; lon: number; title: string; slug: string }>;
  height?: string;
  id?: string;
}

const { 
  lat = 35.6895, 
  lon = 139.6917, 
  zoom = 13, 
  markers = [], 
  height = "400px",
  id = "map-" + Math.random().toString(36).substring(2, 9)
} = Astro.props;

const base = import.meta.env.BASE_URL;
---

<div id={id} class="map-container" style={`height: ${height}; border-radius: var(--radius-lg); margin: var(--space-xl) 0; border: 1px solid var(--glass-border); overflow: hidden;`}></div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script is:inline define:vars={{ lat, lon, zoom, markers, id, base }}>
  document.addEventListener('astro:page-load', () => {
    const mapElement = document.getElementById(id);
    if (!mapElement || typeof L === 'undefined') return;

    // Create map
    const map = L.map(id).setView([lat, lon], zoom);

    // Add Tile Layer (Dark theme compatible)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 20
    }).addTo(map);

    // Custom Icon
    const travelIcon = L.icon({
      iconUrl: `${base}/favicon.svg`,
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    // Add Markers
    if (markers.length > 0) {
      const group = L.featureGroup();
      markers.forEach(m => {
        const marker = L.marker([m.lat, m.lon], { icon: travelIcon })
          .bindPopup(`<strong>${m.title}</strong><br><a href="${base}/locations/${m.slug}/">Vedi dettagli</a>`)
          .addTo(group);
      });
      group.addTo(map);
      
      // Auto-fit bounds if multiple markers
      if (markers.length > 1) {
        map.fitBounds(group.getBounds(), { padding: [50, 50] });
      } else if (markers.length === 1) {
        map.setView([markers[0].lat, markers[0].lon], zoom);
      }
    } else {
      // Single center marker
      L.marker([lat, lon], { icon: travelIcon }).addTo(map);
    }

    // Fix grayscale issue on dark maps if needed
    mapElement.style.filter = "grayscale(0.2) contrast(1.1)";
  });
</script>

<style>
  .map-container {
    z-index: 1;
    background: var(--bg-card);
  }
  
  :global(.leaflet-popup-content-wrapper) {
    background: var(--bg-card) !important;
    color: var(--text-main) !important;
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(10px);
  }
  
  :global(.leaflet-popup-tip) {
    background: var(--bg-card) !important;
  }
</style>
