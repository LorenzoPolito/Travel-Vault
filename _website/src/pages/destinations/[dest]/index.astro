---
import { getCollection } from 'astro:content';
import Base from '../../../layouts/Base.astro';
import Map from '../../../components/Map.astro';

export async function getStaticPaths() {
  const locations = await getCollection('locations');
  const itineraries = await getCollection('itineraries');
  const infoEntries = await getCollection('info');

  const destinations = new Set<string>();
  locations.forEach(l => { if (l.data.destination) destinations.add(l.data.destination); });
  itineraries.forEach(i => { if (i.data.destination) destinations.add(i.data.destination); });

  return Array.from(destinations).map(dest => ({
    params: { dest: dest.toLowerCase() },
    props: {
      destination: dest,
      locations: locations.filter(l => l.data.destination === dest),
      itineraries: itineraries.filter(i => i.data.destination === dest),
      info: infoEntries.filter(e => e.data.destination === dest),
    },
  }));
}

const { destination, locations, itineraries, info } = Astro.props;
const base = import.meta.env.BASE_URL;

const cities = locations.filter((l: any) => l.data.type === 'city');
const pois = locations.filter((l: any) => l.data.type === 'location');

// Group POIs by category
const categories: Record<string, any[]> = {};
pois.forEach((poi: any) => {
  const cat = poi.data.category || 'Altro';
  if (!categories[cat]) categories[cat] = [];
  categories[cat].push(poi);
});

// Prepare markers for the map
const markers = pois
  .filter(p => p.data.location && Array.isArray(p.data.location))
  .map(p => ({
    lat: (p.data.location as number[])[0],
    lon: (p.data.location as number[])[1],
    title: p.id.split('/').pop()?.replace(/-/g, ' ').replace(/\.md$/, '').replace(/\b\w/g, (l: string) => l.toUpperCase()) || p.id,
    slug: p.id.split('/').pop()?.replace(/\.md$/, '') || p.id
  }));

const emoji = destination === 'Japan' ? 'ğŸ‡¯ğŸ‡µ' : destination === 'Italia' ? 'ğŸ‡®ğŸ‡¹' : 'ğŸŒ';
---

<Base title={destination} description={`Tutti i luoghi, itinerari e guide per ${destination}`}>
  <section class="section">
    <div class="container">
      <div class="breadcrumbs">
        <a href={`${base}/`}>Home</a>
        <span class="separator">/</span>
        <a href={`${base}/destinations/`}>Destinazioni</a>
        <span class="separator">/</span>
        <span>{destination}</span>
      </div>

      <div class="page-header" style="border: none">
        <h1 class="page-title">{emoji} {destination}</h1>
        <div class="page-meta">
          <span class="tag">{cities.length} cittÃ </span>
          <span class="tag tag--info">{pois.length} luoghi</span>
          <span class="tag tag--success">{itineraries.length} itinerari</span>
        </div>
      </div>

      {markers.length > 0 && (
        <div style="margin-bottom: var(--space-3xl)">
          <div class="section-header">
            <p class="section-label">Mappa</p>
            <h2>Esplora i luoghi sulla mappa</h2>
          </div>
          <Map markers={markers} height="450px" zoom={6} />
        </div>
      )}

      {cities.length > 0 && (
        <div style="margin-bottom: var(--space-3xl)">
          <div class="section-header">
            <p class="section-label">CittÃ </p>
            <h2>Le cittÃ  da esplorare</h2>
          </div>
          <div class="cards-grid">
            {cities.map((city: any) => {
              const cityName = city.id.split('/').pop()?.replace(/-/g, ' ').replace(/\.md$/, '') || city.id;
              const cityPois = pois.filter((p: any) => p.data.city && cityName.toLowerCase().includes(p.data.city.toLowerCase()));
              return (
                <a href={`${base}/locations/${city.id.split('/').pop()?.replace(/\.md$/, '')}/`} class="card animate-in" style="text-decoration: none">
                  <div class="card-emoji">ğŸ™ï¸</div>
                  <h3 class="card-title">{cityName}</h3>
                  <p class="card-description">{cityPois.length} punti di interesse</p>
                </a>
              );
            })}
          </div>
        </div>
      )}

      {Object.keys(categories).length > 0 && (
        <div style="margin-bottom: var(--space-3xl)">
          <div class="section-header">
            <p class="section-label">Luoghi</p>
            <h2>Punti di interesse per categoria</h2>
          </div>
          {Object.entries(categories).map(([cat, items]) => {
            const catEmoji = cat.toLowerCase().includes('templ') ? 'â›©ï¸' :
                            cat.toLowerCase().includes('park') ? 'ğŸŒ³' :
                            cat.toLowerCase().includes('build') ? 'ğŸ¢' :
                            cat.toLowerCase().includes('store') ? 'ğŸ›ï¸' :
                            cat.toLowerCase().includes('castle') ? 'ğŸ¯' : 'ğŸ“';
            return (
              <div style="margin-bottom: var(--space-xl)">
                <h3>{catEmoji} {cat} ({items.length})</h3>
                <div class="cards-grid" style="margin-top: var(--space-md)">
                  {items.slice(0, 6).map((poi: any) => {
                    const poiName = poi.id.split('/').pop()?.replace(/-/g, ' ').replace(/\.md$/, '') || poi.id;
                    return (
                      <a href={`${base}/locations/${poi.id.split('/').pop()?.replace(/\.md$/, '')}/`} class="card animate-in" style="text-decoration: none">
                        <h4 class="card-title">{poiName}</h4>
                        <div class="card-meta">
                          {poi.data.rating && <span class="rating">â­ {poi.data.rating}</span>}
                          {poi.data.city && <span class="tag">{poi.data.city}</span>}
                        </div>
                      </a>
                    );
                  })}
                </div>
              </div>
            );
          })}
        </div>
      )}

      {itineraries.length > 0 && (
        <div>
          <div class="section-header">
            <p class="section-label">Itinerari</p>
            <h2>Viaggi pianificati</h2>
          </div>
          <div class="cards-grid">
            {itineraries.map((itin: any) => {
              const name = itin.id.split('/').pop()?.replace(/-/g, ' ').replace(/\.md$/, '').replace(/\b\w/g, (l: string) => l.toUpperCase()) || itin.id;
              const emoji = itin.data.tags?.includes('dettagliato') ? 'ğŸ“‹' : 'ğŸ—ºï¸';
              return (
                <a href={`${base}/itineraries/${itin.id.split('/').pop()?.replace(/\.md$/, '')}/`} class="card animate-in" style="text-decoration: none">
                  <div class="card-emoji">{emoji}</div>
                  <h3 class="card-title">{name}</h3>
                  <div class="card-meta">
                    {itin.data.durata && <span class="tag tag--info">{itin.data.durata}</span>}
                    {itin.data.status && <span class="tag tag--success">{itin.data.status}</span>}
                  </div>
                </a>
              );
            })}
          </div>
        </div>
      )}
    </div>
  </section>
</Base>
